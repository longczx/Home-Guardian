{extend name="admin/layout" /}
{block name="content"}
<div class="layui-card">
    <div class="layui-card-header">
        自动化规则
        <a href="/admin/automations/create" class="layui-btn layui-btn-sm layui-btn-normal" style="float:right;margin-top:3px;">
            <i class="layui-icon layui-icon-add-1"></i> 添加规则
        </a>
    </div>
    <div class="layui-card-body">
        <form class="layui-form" method="get" style="margin-bottom:15px;">
            <div class="layui-inline">
                <select name="trigger_type">
                    <option value="">全部类型</option>
                    <option value="telemetry" {{($filters['trigger_type'] ?? '') === 'telemetry' ? 'selected' : ''}}>遥测条件</option>
                    <option value="schedule" {{($filters['trigger_type'] ?? '') === 'schedule' ? 'selected' : ''}}>定时计划</option>
                </select>
            </div>
            <div class="layui-inline">
                <button class="layui-btn layui-btn-sm" lay-submit>筛选</button>
                <a href="/admin/automations" class="layui-btn layui-btn-sm layui-btn-primary">重置</a>
            </div>
        </form>

        <table class="layui-table" lay-skin="line">
            <colgroup><col width="60"><col><col width="100"><col width="80"><col width="170"><col width="150"></colgroup>
            <thead>
                <tr><th>ID</th><th>名称</th><th>触发类型</th><th>启用</th><th>最近触发</th><th>操作</th></tr>
            </thead>
            <tbody>
                {volist name="automationList" id="auto"}
                <tr>
                    <td>{{$auto['id']}}</td>
                    <td>{{$auto['name']}}</td>
                    <td>
                        {if $auto['trigger_type'] === 'telemetry'}
                        <span class="layui-badge layui-bg-blue">遥测条件</span>
                        {else/}
                        <span class="layui-badge layui-bg-cyan">定时计划</span>
                        {/if}
                    </td>
                    <td>
                        {if $auto['is_enabled']}
                        <span class="layui-badge layui-bg-green">启用</span>
                        {else/}
                        <span class="layui-badge layui-bg-gray">禁用</span>
                        {/if}
                    </td>
                    <td>{{$auto['last_triggered_at'] ?? '-'}}</td>
                    <td>
                        <a href="/admin/automations/{{$auto['id']}}/edit" class="layui-btn layui-btn-xs">编辑</a>
                        <form method="post" action="/admin/automations/{{$auto['id']}}/delete" style="display:inline;" onsubmit="return confirm('确定删除？')">
                            <button type="submit" class="layui-btn layui-btn-xs layui-btn-danger">删除</button>
                        </form>
                    </td>
                </tr>
                {/volist}
                {empty name="automations"}
                <tr><td colspan="6" style="text-align:center;color:#999;">暂无自动化规则</td></tr>
                {/empty}
            </tbody>
        </table>

        {if $automations instanceof \Illuminate\Contracts\Pagination\LengthAwarePaginator && $automations->lastPage() > 1}
        <div id="pager"></div>
        {/if}
    </div>
</div>
{/block}

{block name="script"}
<script>
{if $automations instanceof \Illuminate\Contracts\Pagination\LengthAwarePaginator && $automations->lastPage() > 1}
layui.use('laypage', function(){
    layui.laypage.render({
        elem: 'pager',
        count: {{$automations->total()}},
        curr: {{$automations->currentPage()}},
        limit: {{$automations->perPage()}},
        jump: function(obj, first){
            if(!first){ var url = new URL(window.location); url.searchParams.set('page', obj.curr); window.location = url; }
        }
    });
});
{/if}
</script>
{/block}
