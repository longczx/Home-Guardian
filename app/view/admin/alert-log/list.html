{extend name="admin/layout" /}
{block name="content"}
<div class="layui-card">
    <div class="layui-card-header">告警日志</div>
    <div class="layui-card-body">
        <form class="layui-form" method="get" style="margin-bottom:15px;">
            <div class="layui-inline">
                <select name="status">
                    <option value="">全部状态</option>
                    <option value="triggered" {{($filters['status'] ?? '') === 'triggered' ? 'selected' : ''}}>触发中</option>
                    <option value="acknowledged" {{($filters['status'] ?? '') === 'acknowledged' ? 'selected' : ''}}>已确认</option>
                    <option value="resolved" {{($filters['status'] ?? '') === 'resolved' ? 'selected' : ''}}>已解决</option>
                </select>
            </div>
            <div class="layui-inline">
                <button class="layui-btn layui-btn-sm" lay-submit>筛选</button>
                <a href="/admin/alert-logs" class="layui-btn layui-btn-sm layui-btn-primary">重置</a>
            </div>
        </form>

        <table class="layui-table" lay-skin="line">
            <colgroup><col width="60"><col><col><col width="100"><col width="170"><col width="180"></colgroup>
            <thead>
                <tr><th>ID</th><th>规则</th><th>设备</th><th>状态</th><th>触发时间</th><th>操作</th></tr>
            </thead>
            <tbody>
                {volist name="logList" id="log"}
                <tr>
                    <td>{{$log['id']}}</td>
                    <td>{{$log['rule']['name'] ?? '-'}}</td>
                    <td>{{$log['device']['name'] ?? '-'}} ({{$log['device']['location'] ?? ''}})</td>
                    <td>
                        {switch name="log.status"}
                            {case value="triggered"}<span class="layui-badge">触发</span>{/case}
                            {case value="acknowledged"}<span class="layui-badge layui-bg-orange">已确认</span>{/case}
                            {case value="resolved"}<span class="layui-badge layui-bg-green">已解决</span>{/case}
                        {/switch}
                    </td>
                    <td>{{$log['triggered_at']}}</td>
                    <td>
                        {if $log['status'] === 'triggered'}
                        <form method="post" action="/admin/alert-logs/{{$log['id']}}/acknowledge" style="display:inline;">
                            <button type="submit" class="layui-btn layui-btn-xs layui-btn-warm">确认</button>
                        </form>
                        {/if}
                        {if $log['status'] !== 'resolved'}
                        <form method="post" action="/admin/alert-logs/{{$log['id']}}/resolve" style="display:inline;">
                            <button type="submit" class="layui-btn layui-btn-xs layui-btn-normal">解决</button>
                        </form>
                        {/if}
                    </td>
                </tr>
                {/volist}
                {empty name="logs"}
                <tr><td colspan="6" style="text-align:center;color:#999;">暂无告警日志</td></tr>
                {/empty}
            </tbody>
        </table>

        {if $logs instanceof \Illuminate\Contracts\Pagination\LengthAwarePaginator && $logs->lastPage() > 1}
        <div id="pager"></div>
        {/if}
    </div>
</div>
{/block}

{block name="script"}
<script>
{if $logs instanceof \Illuminate\Contracts\Pagination\LengthAwarePaginator && $logs->lastPage() > 1}
layui.use('laypage', function(){
    layui.laypage.render({
        elem: 'pager',
        count: {{$logs->total()}},
        curr: {{$logs->currentPage()}},
        limit: {{$logs->perPage()}},
        jump: function(obj, first){
            if(!first){ var url = new URL(window.location); url.searchParams.set('page', obj.curr); window.location = url; }
        }
    });
});
{/if}
</script>
{/block}
