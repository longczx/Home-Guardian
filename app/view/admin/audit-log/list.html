{extend name="admin/layout" /}
{block name="content"}
<div class="layui-card">
    <div class="layui-card-header">审计日志</div>
    <div class="layui-card-body">
        <form class="layui-form" method="get" style="margin-bottom:15px;">
            <div class="layui-inline">
                <select name="action">
                    <option value="">全部操作</option>
                    <option value="login" {{($filters['action'] ?? '') === 'login' ? 'selected' : ''}}>登录</option>
                    <option value="logout" {{($filters['action'] ?? '') === 'logout' ? 'selected' : ''}}>注销</option>
                    <option value="create" {{($filters['action'] ?? '') === 'create' ? 'selected' : ''}}>创建</option>
                    <option value="update" {{($filters['action'] ?? '') === 'update' ? 'selected' : ''}}>更新</option>
                    <option value="delete" {{($filters['action'] ?? '') === 'delete' ? 'selected' : ''}}>删除</option>
                    <option value="command_send" {{($filters['action'] ?? '') === 'command_send' ? 'selected' : ''}}>下发指令</option>
                </select>
            </div>
            <div class="layui-inline">
                <select name="resource_type">
                    <option value="">全部资源</option>
                    <option value="user" {{($filters['resource_type'] ?? '') === 'user' ? 'selected' : ''}}>用户</option>
                    <option value="device" {{($filters['resource_type'] ?? '') === 'device' ? 'selected' : ''}}>设备</option>
                    <option value="alert_rule" {{($filters['resource_type'] ?? '') === 'alert_rule' ? 'selected' : ''}}>告警规则</option>
                    <option value="automation" {{($filters['resource_type'] ?? '') === 'automation' ? 'selected' : ''}}>自动化</option>
                </select>
            </div>
            <div class="layui-inline">
                <button class="layui-btn layui-btn-sm" lay-submit>筛选</button>
                <a href="/admin/audit-logs" class="layui-btn layui-btn-sm layui-btn-primary">重置</a>
            </div>
        </form>

        <table class="layui-table" lay-skin="line">
            <colgroup><col width="60"><col width="100"><col width="80"><col width="80"><col width="60"><col><col width="120"><col width="170"></colgroup>
            <thead>
                <tr><th>ID</th><th>用户</th><th>操作</th><th>资源类型</th><th>资源ID</th><th>详情</th><th>IP</th><th>时间</th></tr>
            </thead>
            <tbody>
                {volist name="logList" id="log"}
                <tr>
                    <td>{{$log['id']}}</td>
                    <td>{{$log['user']['username'] ?? '(已删除)'}}</td>
                    <td><span class="layui-badge layui-bg-blue">{{$log['action']}}</span></td>
                    <td>{{$log['resource_type']}}</td>
                    <td>{{$log['resource_id'] ?? '-'}}</td>
                    <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="{{:json_encode($log['detail'] ?? [])}}">
                        <code>{{:json_encode($log['detail'] ?? [], JSON_UNESCAPED_UNICODE)}}</code>
                    </td>
                    <td>{{$log['ip_address'] ?? '-'}}</td>
                    <td>{{$log['created_at']}}</td>
                </tr>
                {/volist}
                {empty name="logs"}
                <tr><td colspan="8" style="text-align:center;color:#999;">暂无审计日志</td></tr>
                {/empty}
            </tbody>
        </table>

        {if $logs instanceof \Illuminate\Contracts\Pagination\LengthAwarePaginator && $logs->lastPage() > 1}
        <div id="pager"></div>
        {/if}
    </div>
</div>
{/block}

{block name="script"}
<script>
{if $logs instanceof \Illuminate\Contracts\Pagination\LengthAwarePaginator && $logs->lastPage() > 1}
layui.use('laypage', function(){
    layui.laypage.render({
        elem: 'pager',
        count: {{$logs->total()}},
        curr: {{$logs->currentPage()}},
        limit: {{$logs->perPage()}},
        jump: function(obj, first){
            if(!first){ var url = new URL(window.location); url.searchParams.set('page', obj.curr); window.location = url; }
        }
    });
});
{/if}
</script>
{/block}
