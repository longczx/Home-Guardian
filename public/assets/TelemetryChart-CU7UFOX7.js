import{u as V,E as I,i as R,a as q,b as F,c as K,d as P,e as Y,f as Z}from"./echarts-B6vpBpCQ.js";import{_ as G}from"./TimeRangePicker.vue_vue_type_script_setup_true_lang-DMQdOESZ.js";import{a as H}from"./index-WsV9NrLY.js";import{g as J}from"./device-enMWkg-k.js";import{r as z}from"./request-DAKZCXKs.js";import{d as Q,K as W,w as X,o as ee,L as ae,M as D,O as w,u as r,E as o,B as y,P as te,r as i,D as k,a3 as $,ah as B,al as le,ac as re,z as E,ad as se,Y as oe,c as ne}from"./naive-ui-BdchKIzk.js";function ue(m){return z.get("/telemetry",{params:m})}function ie(m){return z.get("/telemetry/aggregated",{params:m})}const be=Q({__name:"TelemetryChart",setup(m){V([R,q,F,K,P,Y,Z]);const A=W(),p=H(),h=i([]),n=i([]),g=i("temperature"),v=i(!1),b=i([]),c=i(!0),f=i({start:"",end:""}),L=ne(()=>{const e=p.isDark,a=[],t=[],u={};b.value.forEach(s=>{const d=s.device_id;u[d]||(u[d]=[]),u[d].push(s)});const T=Object.fromEntries(h.value.map(s=>[s.value,s.label]));return Object.entries(u).forEach(([s,d])=>{var N;const x=T[Number(s)]||`设备 ${s}`;t.push(x);const _=d.sort((l,S)=>{const j=l.hour||l.recorded_at||l.timestamp||"",U=S.hour||S.recorded_at||S.timestamp||"";return j.localeCompare(U)});a.push({name:x,type:"line",smooth:!0,showSymbol:!1,data:_.map(l=>[l.hour||l.recorded_at||l.timestamp,c.value?Number(l.avg_value??l.value):Number(l.value)])}),c.value&&((N=_[0])==null?void 0:N.min_value)!=null&&a.push({name:`${x} (范围)`,type:"line",smooth:!0,showSymbol:!1,lineStyle:{opacity:0},areaStyle:{opacity:.1},data:_.map(l=>[l.hour,[Number(l.min_value),Number(l.max_value)]]),tooltip:{show:!1}})}),{backgroundColor:"transparent",tooltip:{trigger:"axis",backgroundColor:e?"rgba(36,36,40,0.95)":"#fff",borderColor:e?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)",textStyle:{color:e?"#fff":"#333"}},legend:{data:t,textStyle:{color:e?"rgba(255,255,255,0.65)":"rgba(0,0,0,0.65)"}},grid:{left:50,right:30,top:50,bottom:60},xAxis:{type:"time",axisLabel:{color:e?"rgba(255,255,255,0.45)":"rgba(0,0,0,0.45)"},axisLine:{lineStyle:{color:e?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}}},yAxis:{type:"value",axisLabel:{color:e?"rgba(255,255,255,0.45)":"rgba(0,0,0,0.45)"},splitLine:{lineStyle:{color:e?"rgba(255,255,255,0.06)":"rgba(0,0,0,0.06)"}}},dataZoom:[{type:"inside"},{type:"slider",height:20,bottom:10}],series:a}});async function O(){var e;try{const a=await J({per_page:200}),t=((e=a.data)==null?void 0:e.data)||a.data||[];h.value=t.map(u=>({label:u.name,value:u.id})),t.length>0&&n.value.length===0&&(n.value=[t[0].id])}catch{}}async function C(){var e;if(!(n.value.length===0||!f.value.start)){v.value=!0;try{const a={device_id:n.value.join(","),metric:g.value,start_time:f.value.start,end_time:f.value.end};if(c.value){const t=await ie(a);b.value=t.data||[]}else{a.per_page=500;const t=await ue(a);b.value=((e=t.data)==null?void 0:e.data)||t.data||[]}}catch{A.error("加载数据失败")}finally{v.value=!1}}}function M(e){f.value=e,C()}return X([n,g,c],()=>{C()}),ee(O),(e,a)=>(k(),ae("div",null,[D("h2",{class:"text-lg font-semibold mb-4",style:w({color:r(p).isDark?"#fff":"#1a1a1a"})}," 数据图表 ",4),o(r(te),{style:w({backgroundColor:r(p).cardBg,backdropFilter:"blur(12px)",borderRadius:"12px",border:r(p).isDark?"1px solid rgba(255,255,255,0.06)":"1px solid rgba(0,0,0,0.06)"})},{default:y(()=>[o(r($),{class:"mb-4",align:"center",wrap:!0},{default:y(()=>[o(r(B),{value:n.value,"onUpdate:value":a[0]||(a[0]=t=>n.value=t),options:h.value,multiple:"",placeholder:"选择设备",style:{"min-width":"250px"},"max-tag-count":"responsive"},null,8,["value","options"]),o(r(B),{value:g.value,"onUpdate:value":a[1]||(a[1]=t=>g.value=t),options:[{label:"temperature",value:"temperature"},{label:"humidity",value:"humidity"},{label:"pressure",value:"pressure"},{label:"battery",value:"battery"}],tag:"",filterable:"",placeholder:"输入指标名",style:{width:"180px"}},null,8,["value"]),o(r($),{align:"center",size:4},{default:y(()=>[D("span",{style:w({color:r(p).isDark?"rgba(255,255,255,0.65)":"rgba(0,0,0,0.65)",fontSize:"13px"})}," 聚合 ",4),o(r(le),{value:c.value,"onUpdate:value":a[2]||(a[2]=t=>c.value=t),size:"small"},null,8,["value"])]),_:1}),o(G,{onChange:M})]),_:1}),o(r(re),{show:v.value},{default:y(()=>[b.value.length>0?(k(),E(r(I),{key:0,option:L.value,autoresize:"",style:{height:"450px"}},null,8,["option"])):v.value?oe("",!0):(k(),E(r(se),{key:1,description:"暂无数据，请选择设备和时间范围",class:"py-16"}))]),_:1},8,["show"])]),_:1},8,["style"])]))}});export{be as default};
