import{b as U,a as B,d as V,u as H}from"./index-WsV9NrLY.js";import{_ as J}from"./StatusBadge.vue_vue_type_script_setup_true_lang-CSbWFjI_.js";import{H as G}from"./HardwareChipOutline-BraMyU4d.js";import{d as E,D as p,L as y,O as c,u as e,M as u,E as g,a1 as z,B as T,a2 as S,a8 as F,a9 as I,c as W,Y as L,r as w,aa as K,ab as Y,K as Q,o as X,U as P,ac as Z,P as ee,z as j,ad as te,ae,h as se}from"./naive-ui-BdchKIzk.js";import{r as N}from"./request-DAKZCXKs.js";import{R as le}from"./RefreshOutline-CFFu2u4W.js";const re={class:"flex items-center justify-between mb-3"},oe={class:"flex items-center gap-2"},ne={key:0,class:"grid grid-cols-2 gap-2"},ie=E({__name:"DeviceCard",props:{device:{}},setup(r){const a=r,n=U(),l=B(),f=W(()=>a.device.latestTelemetry?Object.entries(a.device.latestTelemetry).filter(([i])=>!["device_id","timestamp"].includes(i)).slice(0,4):[]);function o(){n.push({name:"device-detail",params:{id:a.device.id}})}return(i,s)=>(p(),y("div",{class:"p-4 rounded-xl cursor-pointer transition-all hover:scale-[1.02]",style:c({backgroundColor:e(l).cardBg,backdropFilter:"blur(12px)",border:e(l).isDark?"1px solid rgba(255,255,255,0.06)":"1px solid rgba(0,0,0,0.06)"}),onClick:o},[u("div",re,[u("div",oe,[u("div",{class:"w-8 h-8 rounded-lg flex items-center justify-center",style:c({backgroundColor:e(l).isDark?"rgba(24,160,88,0.15)":"rgba(24,160,88,0.1)"})},[g(e(z),{size:18,color:"#18a058"},{default:T(()=>[g(e(G))]),_:1})],4),u("div",null,[u("div",{class:"font-medium text-sm",style:c({color:e(l).isDark?"#fff":"#1a1a1a"})},S(r.device.name),5),u("div",{class:"text-xs",style:c({color:e(l).isDark?"rgba(255,255,255,0.38)":"rgba(0,0,0,0.38)"})},S(r.device.location||r.device.type),5)])]),g(J,{status:r.device.status},null,8,["status"])]),f.value.length?(p(),y("div",ne,[(p(!0),y(F,null,I(f.value,([d,k])=>(p(),y("div",{key:d,class:"text-xs rounded-lg px-2 py-1.5",style:c({backgroundColor:e(l).isDark?"rgba(255,255,255,0.04)":"rgba(0,0,0,0.03)"})},[u("span",{style:c({color:e(l).isDark?"rgba(255,255,255,0.38)":"rgba(0,0,0,0.38)"})},S(d),5),u("span",{class:"ml-1 font-medium",style:c({color:e(l).isDark?"#fff":"#1a1a1a"})},S(k),5)],4))),128))])):(p(),y("div",{key:1,class:"text-xs",style:c({color:e(l).isDark?"rgba(255,255,255,0.25)":"rgba(0,0,0,0.25)"})}," 暂无遥测数据 ",4))],4))}}),ce={class:"flex items-end gap-1"},A=E({__name:"MetricGauge",props:{label:{},value:{},unit:{},icon:{},color:{}},setup(r){const a=r,n=B();return(l,f)=>(p(),y("div",{class:"p-4 rounded-xl",style:c({backgroundColor:e(n).cardBg,backdropFilter:"blur(12px)",border:e(n).isDark?"1px solid rgba(255,255,255,0.06)":"1px solid rgba(0,0,0,0.06)"})},[u("div",{class:"text-xs mb-2",style:c({color:e(n).isDark?"rgba(255,255,255,0.45)":"rgba(0,0,0,0.45)"})},S(a.label),5),u("div",ce,[u("span",{class:"text-2xl font-bold tabular-nums",style:c({color:a.color||(e(n).isDark?"#fff":"#1a1a1a")})},S(a.value),5),a.unit?(p(),y("span",{key:0,class:"text-sm mb-0.5",style:c({color:e(n).isDark?"rgba(255,255,255,0.45)":"rgba(0,0,0,0.45)"})},S(a.unit),5)):L("",!0)])],4))}}),q=V("device",()=>{const r=w([]),a=w(!1);async function n(o){var i;a.value=!0;try{const s=await N.get("/devices",{params:o});r.value=((i=s.data)==null?void 0:i.data)||s.data||[]}finally{a.value=!1}}function l(o,i){const s=r.value.find(d=>d.id===o);s&&(s.latestTelemetry={...s.latestTelemetry,...i})}function f(o,i){const s=r.value.find(d=>d.id===o);s&&(s.status=i)}return{devices:r,loading:a,fetchDevices:n,updateDeviceTelemetry:l,updateDeviceStatus:f}});function ue(){const r=w(null),a=w(!1),n=H(),l=q(),f=B();let o=null,i=0;const s=3e4;let d=null;try{d=K()}catch{}function k(){return`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}/ws?token=${n.accessToken}`}function R(){var m;if(((m=r.value)==null?void 0:m.readyState)===WebSocket.OPEN||!n.accessToken)return;const t=new WebSocket(k());t.onopen=()=>{a.value=!0,i=0},t.onmessage=_=>{try{const D=JSON.parse(_.data);O(D)}catch{}},t.onclose=()=>{a.value=!1,v()},t.onerror=()=>{t.close()},r.value=t}function O(t){var m,_,D,x;switch(t.type){case"telemetry_update":l.updateDeviceTelemetry((m=t.data)==null?void 0:m.device_id,t.data);break;case"device_status":l.updateDeviceStatus((_=t.data)==null?void 0:_.device_id,(D=t.data)==null?void 0:D.status);break;case"alert_triggered":f.setAlertCount(f.alertCount+1),d==null||d.warning({title:"告警触发",content:((x=t.data)==null?void 0:x.message)||"设备告警",duration:5e3});break}}function v(){if(o)return;const t=Math.min(1e3*Math.pow(2,i),s);i++,o=setTimeout(()=>{o=null,n.isLoggedIn&&R()},t)}function b(){var t;o&&(clearTimeout(o),o=null),(t=r.value)==null||t.close(),r.value=null,a.value=!1}function h(){var t;((t=r.value)==null?void 0:t.readyState)===WebSocket.OPEN&&r.value.send(JSON.stringify({type:"ping"}))}const C=setInterval(h,3e4);return Y(()=>{clearInterval(C),b()}),{connected:a,connect:R,disconnect:b}}const de={class:"flex items-center justify-between mb-4"},ve={class:"grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6"},ge={key:0,class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6"},he=E({__name:"Dashboard",setup(r){const a=Q(),n=q(),l=B(),{connect:f}=ue(),o=w(!0),i=w([]),s=w({totalDevices:0,onlineDevices:0,activeAlerts:0,todayDataPoints:0}),d=W(()=>s.value.totalDevices===0?"0":(s.value.onlineDevices/s.value.totalDevices*100).toFixed(0));async function k(){var v,b,h;o.value=!0;try{const[C,t]=await Promise.all([N.get("/devices",{params:{per_page:100}}),N.get("/alert-logs",{params:{per_page:5,status:"triggered"}})]),m=((v=C.data)==null?void 0:v.data)||C.data||[];n.devices=m,s.value.totalDevices=m.length,s.value.onlineDevices=m.filter(x=>x.status==="online").length;const _=((b=t.data)==null?void 0:b.data)||t.data||[];i.value=_,s.value.activeAlerts=((h=t.data)==null?void 0:h.total)||_.length;const D=m.filter(x=>x.status==="online");if(D.length>0)try{const M=(await N.get("/telemetry/latest",{params:{device_id:D.map($=>$.id).join(",")}})).data||[];Array.isArray(M)&&M.forEach($=>{n.updateDeviceTelemetry($.device_id,$)})}catch{}}catch{a.error("加载数据失败")}finally{o.value=!1}}async function R(v){try{await N.patch(`/alert-logs/${v}/acknowledge`),a.success("已确认告警"),k()}catch{a.error("操作失败")}}const O=[{title:"时间",key:"triggered_at",width:170,render:v=>{var b;return((b=v.triggered_at)==null?void 0:b.replace("T"," ").slice(0,19))||"-"}},{title:"规则",key:"rule_name",ellipsis:!0},{title:"设备",key:"device_name",ellipsis:!0},{title:"消息",key:"message",ellipsis:!0},{title:"操作",key:"action",width:80,render:v=>v.status==="triggered"?se(P,{size:"tiny",type:"primary",quaternary:!0,onClick:()=>R(v.id)},{default:()=>"确认"}):v.status}];return X(()=>{k(),f()}),(v,b)=>(p(),y("div",null,[u("div",de,[u("h2",{class:"text-lg font-semibold",style:c({color:e(l).isDark?"#fff":"#1a1a1a"})}," 概览 ",4),g(e(P),{quaternary:"",circle:"",onClick:k,loading:o.value},{icon:T(()=>[g(e(z),null,{default:T(()=>[g(e(le))]),_:1})]),_:1},8,["loading"])]),u("div",ve,[g(A,{label:"设备总数",value:s.value.totalDevices},null,8,["value"]),g(A,{label:"在线设备",value:s.value.onlineDevices,color:"#18a058"},null,8,["value"]),g(A,{label:"活跃告警",value:s.value.activeAlerts,color:"#d03050"},null,8,["value"]),g(A,{label:"在线率",value:d.value,unit:"%",color:"#2080f0"},null,8,["value"])]),u("h3",{class:"text-base font-medium mb-3",style:c({color:e(l).isDark?"rgba(255,255,255,0.82)":"rgba(0,0,0,0.82)"})}," 设备状态 ",4),g(e(Z),{show:o.value&&e(n).devices.length===0},{default:T(()=>[e(n).devices.length>0?(p(),y("div",ge,[(p(!0),y(F,null,I(e(n).devices,h=>(p(),j(ie,{key:h.id,device:h},null,8,["device"]))),128))])):o.value?L("",!0):(p(),j(e(te),{key:1,description:"暂无设备",class:"py-12"}))]),_:1},8,["show"]),u("h3",{class:"text-base font-medium mb-3",style:c({color:e(l).isDark?"rgba(255,255,255,0.82)":"rgba(0,0,0,0.82)"})}," 最近告警 ",4),g(e(ee),{style:c({backgroundColor:e(l).cardBg,backdropFilter:"blur(12px)",borderRadius:"12px",border:e(l).isDark?"1px solid rgba(255,255,255,0.06)":"1px solid rgba(0,0,0,0.06)"})},{default:T(()=>[g(e(ae),{columns:O,data:i.value,bordered:!1,size:"small",pagination:!1},null,8,["data"])]),_:1},8,["style"])]))}});export{he as default};
