import{a as q}from"./index-WsV9NrLY.js";import{u as F}from"./usePermission-B5lDT5ra.js";import{g as $,u as N,d as j,c as K}from"./alert-Dubs-O-k.js";import{g as L}from"./device-enMWkg-k.js";import{d as Q,K as Y,af as G,o as H,L as J,M as C,O as R,u as t,E as l,B as r,a3 as g,P as W,ag as X,r as d,D as U,U as f,a1 as y,z as Z,V as ee,Y as ae,ae as te,Q as le,R as o,S as h,ah as _,an as se,al as D,h as n,ai as ie}from"./naive-ui-BdchKIzk.js";import{R as re}from"./RefreshOutline-CFFu2u4W.js";import{A as ne,C as oe,T as ue}from"./TrashOutline-CiYK4OLL.js";import"./request-DAKZCXKs.js";const de={class:"flex items-center justify-between mb-4"},_e=Q({__name:"AlertRules",setup(ve){const u=Y(),z=G(),b=q(),{hasPermission:A}=F(),m=d(!1),w=d([]),k=d([]),v=d(!1),p=d(null),s=d({name:"",device_id:null,metric:"",operator:">",threshold:0,severity:"warning",message_template:"",enabled:!0}),O=[{label:">",value:">"},{label:">=",value:">="},{label:"<",value:"<"},{label:"<=",value:"<="},{label:"==",value:"=="},{label:"!=",value:"!="}],S=[{label:"信息",value:"info"},{label:"警告",value:"warning"},{label:"严重",value:"critical"}],B=[{title:"ID",key:"id",width:60},{title:"名称",key:"name",ellipsis:!0},{title:"设备",key:"device_name",width:120,ellipsis:!0,render:e=>{var a;return((a=e.device)==null?void 0:a.name)||e.device_name||e.device_id}},{title:"指标",key:"metric",width:120},{title:"条件",key:"condition",width:140,render:e=>`${e.operator} ${e.threshold}`},{title:"级别",key:"severity",width:80,render:e=>n(ie,{size:"small",type:{info:"info",warning:"warning",critical:"error"}[e.severity]||"default",bordered:!1},()=>e.severity)},{title:"启用",key:"enabled",width:80,render:e=>n(D,{size:"small",value:e.enabled,onUpdateValue:a=>P(e,a)})},{title:"操作",key:"actions",width:100,render:e=>n(g,{size:4},()=>[n(f,{size:"tiny",quaternary:!0,type:"primary",onClick:()=>I(e)},{icon:()=>n(y,null,()=>n(oe))}),n(f,{size:"tiny",quaternary:!0,type:"error",onClick:()=>E(e)},{icon:()=>n(y,null,()=>n(ue))})])}];async function c(){var e;m.value=!0;try{const a=await $({per_page:100});w.value=((e=a.data)==null?void 0:e.data)||a.data||[]}catch{u.error("加载告警规则失败")}finally{m.value=!1}}async function T(){var e;try{const a=await L({per_page:200}),i=((e=a.data)==null?void 0:e.data)||a.data||[];k.value=i.map(x=>({label:x.name,value:x.id}))}catch{}}function V(){p.value=null,s.value={name:"",device_id:null,metric:"",operator:">",threshold:0,severity:"warning",message_template:"",enabled:!0},v.value=!0}function I(e){p.value=e,s.value={name:e.name,device_id:e.device_id,metric:e.metric,operator:e.operator,threshold:e.threshold,severity:e.severity,message_template:e.message_template||"",enabled:e.enabled},v.value=!0}async function M(){var e,a;try{p.value?(await N(p.value.id,s.value),u.success("规则已更新")):(await K(s.value),u.success("规则已创建")),v.value=!1,c()}catch(i){u.error(((a=(e=i.response)==null?void 0:e.data)==null?void 0:a.message)||"操作失败")}}async function P(e,a){try{await N(e.id,{...e,enabled:a}),e.enabled=a}catch{u.error("更新失败")}}function E(e){z.warning({title:"确认删除",content:`确定要删除规则 "${e.name}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await j(e.id),u.success("规则已删除"),c()}catch{u.error("删除失败")}}})}return H(()=>{c(),T()}),(e,a)=>(U(),J("div",null,[C("div",de,[C("h2",{class:"text-lg font-semibold",style:R({color:t(b).isDark?"#fff":"#1a1a1a"})}," 告警规则 ",4),l(t(g),null,{default:r(()=>[l(t(f),{quaternary:"",circle:"",onClick:c,loading:m.value},{icon:r(()=>[l(t(y),null,{default:r(()=>[l(t(re))]),_:1})]),_:1},8,["loading"]),t(A)("alerts.create")?(U(),Z(t(f),{key:0,type:"primary",onClick:V},{icon:r(()=>[l(t(y),null,{default:r(()=>[l(t(ne))]),_:1})]),default:r(()=>[a[9]||(a[9]=ee(" 创建规则 ",-1))]),_:1})):ae("",!0)]),_:1})]),l(t(W),{style:R({backgroundColor:t(b).cardBg,backdropFilter:"blur(12px)",borderRadius:"12px",border:t(b).isDark?"1px solid rgba(255,255,255,0.06)":"1px solid rgba(0,0,0,0.06)"})},{default:r(()=>[l(t(te),{columns:B,data:w.value,loading:m.value,bordered:!1,striped:"",size:"small"},null,8,["data","loading"])]),_:1},8,["style"]),l(t(X),{show:v.value,"onUpdate:show":a[8]||(a[8]=i=>v.value=i),preset:"dialog",title:p.value?"编辑规则":"创建规则","positive-text":"保存","negative-text":"取消",onPositiveClick:M,style:{width:"540px"}},{default:r(()=>[l(t(le),{model:s.value,"label-placement":"left","label-width":"80"},{default:r(()=>[l(t(o),{label:"名称",path:"name"},{default:r(()=>[l(t(h),{value:s.value.name,"onUpdate:value":a[0]||(a[0]=i=>s.value.name=i),placeholder:"规则名称"},null,8,["value"])]),_:1}),l(t(o),{label:"设备",path:"device_id"},{default:r(()=>[l(t(_),{value:s.value.device_id,"onUpdate:value":a[1]||(a[1]=i=>s.value.device_id=i),options:k.value,placeholder:"选择设备",filterable:""},null,8,["value","options"])]),_:1}),l(t(o),{label:"指标",path:"metric"},{default:r(()=>[l(t(h),{value:s.value.metric,"onUpdate:value":a[2]||(a[2]=i=>s.value.metric=i),placeholder:"如 temperature, humidity"},null,8,["value"])]),_:1}),l(t(g),{size:12},{default:r(()=>[l(t(o),{label:"运算符",path:"operator"},{default:r(()=>[l(t(_),{value:s.value.operator,"onUpdate:value":a[3]||(a[3]=i=>s.value.operator=i),options:O,style:{width:"100px"}},null,8,["value"])]),_:1}),l(t(o),{label:"阈值",path:"threshold"},{default:r(()=>[l(t(se),{value:s.value.threshold,"onUpdate:value":a[4]||(a[4]=i=>s.value.threshold=i),style:{width:"140px"}},null,8,["value"])]),_:1})]),_:1}),l(t(o),{label:"级别",path:"severity"},{default:r(()=>[l(t(_),{value:s.value.severity,"onUpdate:value":a[5]||(a[5]=i=>s.value.severity=i),options:S},null,8,["value"])]),_:1}),l(t(o),{label:"消息模板",path:"message_template"},{default:r(()=>[l(t(h),{value:s.value.message_template,"onUpdate:value":a[6]||(a[6]=i=>s.value.message_template=i),type:"textarea",rows:2,placeholder:"告警消息模板"},null,8,["value"])]),_:1}),l(t(o),{label:"启用",path:"enabled"},{default:r(()=>[l(t(D),{value:s.value.enabled,"onUpdate:value":a[7]||(a[7]=i=>s.value.enabled=i)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])]))}});export{_e as default};
