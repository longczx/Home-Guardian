import{_ as I}from"./StatusBadge.vue_vue_type_script_setup_true_lang-CSbWFjI_.js";import{a as A,b as E}from"./index-WsV9NrLY.js";import{u as K}from"./usePermission-B5lDT5ra.js";import{g as L,d as $,u as j,c as Y}from"./device-enMWkg-k.js";import{d as G,K as H,af as J,o as W,L as N,M as U,O as M,u as a,E as s,B as n,a3 as x,P as X,ag as Z,r as i,D as T,U as g,a1 as k,z as ee,V as ae,Y as z,S as c,ah as D,ae as te,Q as le,R as m,a8 as se,h as u,ai as oe}from"./naive-ui-BdchKIzk.js";import{R as ne}from"./RefreshOutline-CFFu2u4W.js";import{A as ue,C as ie,T as re}from"./TrashOutline-CiYK4OLL.js";import"./request-DAKZCXKs.js";const de={class:"flex items-center justify-between mb-4"},ke=G({__name:"DeviceList",setup(ve){const S=E(),d=H(),B=J(),_=A(),{hasPermission:h}=K(),f=i(!1),q=i([]),y=i(""),b=i(null),w=i(null),p=i(!1),v=i(null),o=i({name:"",type:"sensor",location:"",mqtt_username:"",mqtt_password:""}),C=[{label:"全部类型",value:""},{label:"传感器",value:"sensor"},{label:"执行器",value:"actuator"},{label:"网关",value:"gateway"},{label:"摄像头",value:"camera"}],O=[{label:"全部状态",value:""},{label:"在线",value:"online"},{label:"离线",value:"offline"},{label:"未激活",value:"inactive"}],P=[{title:"ID",key:"id",width:60},{title:"名称",key:"name",ellipsis:!0,render:t=>u("a",{class:"cursor-pointer text-[#18a058] hover:underline",onClick:()=>S.push({name:"device-detail",params:{id:t.id}})},t.name)},{title:"类型",key:"type",width:100,render:t=>u(oe,{size:"small",bordered:!1},()=>t.type)},{title:"位置",key:"location",width:120,ellipsis:!0},{title:"Device Key",key:"device_key",width:200,ellipsis:!0},{title:"状态",key:"status",width:90,render:t=>u(I,{status:t.status})},{title:"最后上线",key:"last_seen_at",width:170,render:t=>{var e;return((e=t.last_seen_at)==null?void 0:e.replace("T"," ").slice(0,19))||"-"}},{title:"操作",key:"actions",width:120,render:t=>u(x,{size:4},()=>[h("devices.edit")&&u(g,{size:"tiny",quaternary:!0,type:"primary",onClick:()=>R(t)},{icon:()=>u(k,null,()=>u(ie))}),h("devices.delete")&&u(g,{size:"tiny",quaternary:!0,type:"error",onClick:()=>F(t)},{icon:()=>u(k,null,()=>u(re))})])}];async function r(){var t;f.value=!0;try{const e={per_page:100};y.value&&(e.search=y.value),b.value&&(e.type=b.value),w.value&&(e.status=w.value);const l=await L(e);q.value=((t=l.data)==null?void 0:t.data)||l.data||[]}catch{d.error("加载设备列表失败")}finally{f.value=!1}}function Q(){v.value=null,o.value={name:"",type:"sensor",location:"",mqtt_username:"",mqtt_password:""},p.value=!0}function R(t){v.value=t,o.value={name:t.name,type:t.type,location:t.location||"",mqtt_username:"",mqtt_password:""},p.value=!0}async function V(){var t,e;try{v.value?(await j(v.value.id,o.value),d.success("设备已更新")):(await Y(o.value),d.success("设备已创建")),p.value=!1,r()}catch(l){d.error(((e=(t=l.response)==null?void 0:t.data)==null?void 0:e.message)||"操作失败")}}function F(t){B.warning({title:"确认删除",content:`确定要删除设备 "${t.name}" 吗？此操作不可恢复。`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await $(t.id),d.success("设备已删除"),r()}catch{d.error("删除失败")}}})}return W(r),(t,e)=>(T(),N("div",null,[U("div",de,[U("h2",{class:"text-lg font-semibold",style:M({color:a(_).isDark?"#fff":"#1a1a1a"})}," 设备管理 ",4),s(a(x),null,{default:n(()=>[s(a(g),{quaternary:"",circle:"",onClick:r,loading:f.value},{icon:n(()=>[s(a(k),null,{default:n(()=>[s(a(ne))]),_:1})]),_:1},8,["loading"]),a(h)("devices.create")?(T(),ee(a(g),{key:0,type:"primary",onClick:Q},{icon:n(()=>[s(a(k),null,{default:n(()=>[s(a(ue))]),_:1})]),default:n(()=>[e[9]||(e[9]=ae(" 添加设备 ",-1))]),_:1})):z("",!0)]),_:1})]),s(a(X),{style:M({backgroundColor:a(_).cardBg,backdropFilter:"blur(12px)",borderRadius:"12px",border:a(_).isDark?"1px solid rgba(255,255,255,0.06)":"1px solid rgba(0,0,0,0.06)"})},{default:n(()=>[s(a(x),{class:"mb-4",size:12},{default:n(()=>[s(a(c),{value:y.value,"onUpdate:value":[e[0]||(e[0]=l=>y.value=l),r],placeholder:"搜索设备...",clearable:"",style:{width:"200px"}},null,8,["value"]),s(a(D),{value:b.value,"onUpdate:value":[e[1]||(e[1]=l=>b.value=l),r],options:C,style:{width:"140px"},clearable:""},null,8,["value"]),s(a(D),{value:w.value,"onUpdate:value":[e[2]||(e[2]=l=>w.value=l),r],options:O,style:{width:"140px"},clearable:""},null,8,["value"])]),_:1}),s(a(te),{columns:P,data:q.value,loading:f.value,bordered:!1,striped:"",size:"small"},null,8,["data","loading"])]),_:1},8,["style"]),s(a(Z),{show:p.value,"onUpdate:show":e[8]||(e[8]=l=>p.value=l),preset:"dialog",title:v.value?"编辑设备":"添加设备","positive-text":"保存","negative-text":"取消",onPositiveClick:V,style:{width:"500px"}},{default:n(()=>[s(a(le),{model:o.value,"label-placement":"left","label-width":"80"},{default:n(()=>[s(a(m),{label:"名称",path:"name"},{default:n(()=>[s(a(c),{value:o.value.name,"onUpdate:value":e[3]||(e[3]=l=>o.value.name=l),placeholder:"输入设备名称"},null,8,["value"])]),_:1}),s(a(m),{label:"类型",path:"type"},{default:n(()=>[s(a(D),{value:o.value.type,"onUpdate:value":e[4]||(e[4]=l=>o.value.type=l),options:C.filter(l=>l.value)},null,8,["value","options"])]),_:1}),s(a(m),{label:"位置",path:"location"},{default:n(()=>[s(a(c),{value:o.value.location,"onUpdate:value":e[5]||(e[5]=l=>o.value.location=l),placeholder:"输入设备位置"},null,8,["value"])]),_:1}),v.value?z("",!0):(T(),N(se,{key:0},[s(a(m),{label:"MQTT用户",path:"mqtt_username"},{default:n(()=>[s(a(c),{value:o.value.mqtt_username,"onUpdate:value":e[6]||(e[6]=l=>o.value.mqtt_username=l),placeholder:"MQTT 认证用户名"},null,8,["value"])]),_:1}),s(a(m),{label:"MQTT密码",path:"mqtt_password"},{default:n(()=>[s(a(c),{value:o.value.mqtt_password,"onUpdate:value":e[7]||(e[7]=l=>o.value.mqtt_password=l),type:"password",placeholder:"MQTT 认证密码"},null,8,["value"])]),_:1})],64))]),_:1},8,["model"])]),_:1},8,["show","title"])]))}});export{ke as default};
