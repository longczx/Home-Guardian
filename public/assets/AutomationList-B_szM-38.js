import{a as q}from"./index-WsV9NrLY.js";import{r as b}from"./request-DAKZCXKs.js";import{d as E,K as R,af as F,o as P,L as $,M as N,O as x,u as t,E as l,B as i,a3 as S,P as L,ag as j,r as g,D as K,U as y,a1 as m,V as Q,ae as W,Q as G,R as d,S as _,ah as h,al as C,h as r,ai as O}from"./naive-ui-BdchKIzk.js";import{R as H}from"./RefreshOutline-CFFu2u4W.js";import{A as X,C as Y,T as Z}from"./TrashOutline-CiYK4OLL.js";function ee(s){return b.get("/automations",{params:s})}function ae(s){return b.post("/automations",s)}function U(s,u){return b.put(`/automations/${s}`,u)}function te(s){return b.delete(`/automations/${s}`)}const le={class:"flex items-center justify-between mb-4"},se=E({__name:"AutomationList",setup(s){const u=R(),A=F(),w=q(),v=g(!1),k=g([]),c=g(!1),p=g(null),n=g({name:"",description:"",trigger_type:"telemetry",trigger_config:"{}",action_type:"command",action_config:"{}",enabled:!0}),T=[{label:"遥测触发",value:"telemetry"},{label:"设备状态",value:"device_status"},{label:"定时触发",value:"schedule"}],z=[{label:"发送指令",value:"command"},{label:"发送通知",value:"notification"},{label:"Webhook",value:"webhook"}],D=[{title:"ID",key:"id",width:60},{title:"名称",key:"name",ellipsis:!0},{title:"描述",key:"description",ellipsis:!0},{title:"触发类型",key:"trigger_type",width:110,render:e=>r(O,{size:"small",bordered:!1},()=>e.trigger_type)},{title:"动作类型",key:"action_type",width:110,render:e=>r(O,{size:"small",bordered:!1},()=>e.action_type)},{title:"启用",key:"enabled",width:80,render:e=>r(C,{size:"small",value:e.enabled,onUpdateValue:a=>M(e,a)})},{title:"操作",key:"actions",width:100,render:e=>r(S,{size:4},()=>[r(y,{size:"tiny",quaternary:!0,type:"primary",onClick:()=>J(e)},{icon:()=>r(m,null,()=>r(Y))}),r(y,{size:"tiny",quaternary:!0,type:"error",onClick:()=>V(e)},{icon:()=>r(m,null,()=>r(Z))})])}];async function f(){var e;v.value=!0;try{const a=await ee({per_page:100});k.value=((e=a.data)==null?void 0:e.data)||a.data||[]}catch{u.error("加载失败")}finally{v.value=!1}}function B(){p.value=null,n.value={name:"",description:"",trigger_type:"telemetry",trigger_config:"{}",action_type:"command",action_config:"{}",enabled:!0},c.value=!0}function J(e){p.value=e,n.value={name:e.name,description:e.description||"",trigger_type:e.trigger_type,trigger_config:JSON.stringify(e.trigger_config||{},null,2),action_type:e.action_type,action_config:JSON.stringify(e.action_config||{},null,2),enabled:e.enabled},c.value=!0}async function I(){var e,a;try{const o={...n.value,trigger_config:JSON.parse(n.value.trigger_config),action_config:JSON.parse(n.value.action_config)};p.value?(await U(p.value.id,o),u.success("已更新")):(await ae(o),u.success("已创建")),c.value=!1,f()}catch(o){u.error(((a=(e=o.response)==null?void 0:e.data)==null?void 0:a.message)||"操作失败")}}async function M(e,a){try{await U(e.id,{...e,enabled:a}),e.enabled=a}catch{u.error("更新失败")}}function V(e){A.warning({title:"确认删除",content:`确定要删除自动化 "${e.name}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await te(e.id),u.success("已删除"),f()}catch{u.error("删除失败")}}})}return P(f),(e,a)=>(K(),$("div",null,[N("div",le,[N("h2",{class:"text-lg font-semibold",style:x({color:t(w).isDark?"#fff":"#1a1a1a"})}," 自动化规则 ",4),l(t(S),null,{default:i(()=>[l(t(y),{quaternary:"",circle:"",onClick:f,loading:v.value},{icon:i(()=>[l(t(m),null,{default:i(()=>[l(t(H))]),_:1})]),_:1},8,["loading"]),l(t(y),{type:"primary",onClick:B},{icon:i(()=>[l(t(m),null,{default:i(()=>[l(t(X))]),_:1})]),default:i(()=>[a[8]||(a[8]=Q(" 创建自动化 ",-1))]),_:1})]),_:1})]),l(t(L),{style:x({backgroundColor:t(w).cardBg,backdropFilter:"blur(12px)",borderRadius:"12px",border:t(w).isDark?"1px solid rgba(255,255,255,0.06)":"1px solid rgba(0,0,0,0.06)"})},{default:i(()=>[l(t(W),{columns:D,data:k.value,loading:v.value,bordered:!1,striped:"",size:"small"},null,8,["data","loading"])]),_:1},8,["style"]),l(t(j),{show:c.value,"onUpdate:show":a[7]||(a[7]=o=>c.value=o),preset:"dialog",title:p.value?"编辑自动化":"创建自动化","positive-text":"保存","negative-text":"取消",onPositiveClick:I,style:{width:"580px"}},{default:i(()=>[l(t(G),{model:n.value,"label-placement":"left","label-width":"80"},{default:i(()=>[l(t(d),{label:"名称"},{default:i(()=>[l(t(_),{value:n.value.name,"onUpdate:value":a[0]||(a[0]=o=>n.value.name=o),placeholder:"自动化名称"},null,8,["value"])]),_:1}),l(t(d),{label:"描述"},{default:i(()=>[l(t(_),{value:n.value.description,"onUpdate:value":a[1]||(a[1]=o=>n.value.description=o),type:"textarea",rows:2},null,8,["value"])]),_:1}),l(t(d),{label:"触发类型"},{default:i(()=>[l(t(h),{value:n.value.trigger_type,"onUpdate:value":a[2]||(a[2]=o=>n.value.trigger_type=o),options:T},null,8,["value"])]),_:1}),l(t(d),{label:"触发配置"},{default:i(()=>[l(t(_),{value:n.value.trigger_config,"onUpdate:value":a[3]||(a[3]=o=>n.value.trigger_config=o),type:"textarea",rows:3,placeholder:"JSON 配置"},null,8,["value"])]),_:1}),l(t(d),{label:"动作类型"},{default:i(()=>[l(t(h),{value:n.value.action_type,"onUpdate:value":a[4]||(a[4]=o=>n.value.action_type=o),options:z},null,8,["value"])]),_:1}),l(t(d),{label:"动作配置"},{default:i(()=>[l(t(_),{value:n.value.action_config,"onUpdate:value":a[5]||(a[5]=o=>n.value.action_config=o),type:"textarea",rows:3,placeholder:"JSON 配置"},null,8,["value"])]),_:1}),l(t(d),{label:"启用"},{default:i(()=>[l(t(C),{value:n.value.enabled,"onUpdate:value":a[6]||(a[6]=o=>n.value.enabled=o)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])]))}});export{se as default};
